name: Biweekly Metrics Email

on:
  schedule:
    - cron: "0 13 * * 4"   # Every Thursday 9:00 AM ET (13:00 UTC)
  workflow_dispatch:        # Manual "Run workflow" button

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil

      - name: Skip unless this is an "every other Thursday" starting 2025-10-30
        id: gate
        shell: bash
        run: |
          # 1) Ensure it's Thursday (ISO: Mon=1 ... Thu=4)
          dow=$(date -u +%u)
          if [ "$dow" -ne 4 ]; then
            echo "Not Thursday -> skip"
            exit 78
          fi
          # 2) Weeks since anchor (2025-10-30)
          anchor_ts=$(date -u -d '2025-10-30 00:00:00Z' +%s)
          now_ts=$(date -u +%s)
          weeks=$(( (now_ts - anchor_ts) / 604800 ))
          if [ $weeks -lt 0 ] || [ $((weeks % 2)) -ne 0 ]; then
            echo "Not our biweekly Thursday (weeks since anchor=$weeks) -> skip"
            exit 78
          fi
          echo "Gate passed: run metrics"

      - name: Build metrics report (HTML)
        env:
          REPO: ${{ github.repository }}
          METRICS_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          python scripts/biweekly_metrics.py

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}   # e.g. smtp.gmail.com
          server_port: ${{ secrets.SMTP_PORT }}        # 465
          secure: true                                 # SSL (true for 465)
          username: ${{ secrets.SMTP_USERNAME }}       # your@gmail.com
          password: ${{ secrets.SMTP_PASSWORD }}       # app password
          from: ${{ secrets.FROM_EMAIL }}              # your@gmail.com
          to: ${{ secrets.TO_EMAILS }}                 # me@..., other@...
          subject: "Biweekly Metrics â€“ ${{ github.repository }}"
          html_body: |
            <p>Hi! Your biweekly metrics report is attached.</p>
            <p>Repo: <b>${{ github.repository }}</b><br/>
            Workflow: ${{ github.workflow }}<br/>
            Run: ${{ github.run_number }}</p>
          attachments: metrics_report.html
