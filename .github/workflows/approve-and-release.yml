name: Approve or deny & publish ZIP
on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  handle:
    if: github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    steps:
      - name: Parse admin command
        id: parse
        uses: actions/github-script@v8
        with:
          script: |
            const body = context.payload.comment.body.trim();
            const approve = body.match(/^\/approve\s+@?([\w-]+)/i);
            const deny    = body.match(/^\/deny\s+@?([\w-]+)/i);
            if (approve) { core.setOutput('action','approve'); core.setOutput('user',approve[1]); }
            else if (deny){ core.setOutput('action','deny'); core.setOutput('user',deny[1]); }
            else { core.setOutput('action','none'); }

      - uses: actions/checkout@v4
        if: steps.parse.outputs.action == 'approve'

      - name: Build ZIP from bundle-src/
        if: steps.parse.outputs.action == 'approve'
        run: |
          test -d bundle-src || (echo "bundle-src/ not found." && exit 1)
          zip -r bundle.zip bundle-src

      - name: Publish GitHub Release
        if: steps.parse.outputs.action == 'approve'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: req-${{ steps.parse.outputs.user }}-${{ github.run_number }}
          name: "Approved bundle for @${{ steps.parse.outputs.user }}"
          body: "Requested via issue #${{ github.event.issue.number }}"
          files: bundle.zip

      - name: Comment result
        uses: actions/github-script@v8
        with:
          script: |
            const action = "${{ steps.parse.outputs.action }}";
            const user   = "${{ steps.parse.outputs.user }}";
            let msg = 'No action taken.';
            if (action === 'approve') msg = `Approved. Release published for @${user}. See the Releases tab.`;
            if (action === 'deny')    msg = `Denied for @${user}.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
